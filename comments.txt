Здравствуйте! Несколько комментариев к проекту:

1. Я реализовал идемпотентность для таблиц mart.f_sales и staging.user_order_log (подробности в описании проекта).
Я не стал реализовывать идемпотентность для других таблиц, так-как это потребовало бы создания дополнительных технических полей и замысловатой логики удаления записей, не нарушающей ограничения внешних ключей.
Кроме этого, таблицы mart.d_item, mart.d_customer, mart.d_city работают как справочники и не содержат транзакционную информацию.

2. С моей точки зрения, если реализовывать витрину mart.f_customer_retention, основываясь на ТЗ, представленном на сайте, то мы не получим нужные метрики.
Например, условие: "клиент сделал только один заказ за указанный период" не поможет нам посчитать новых клиентов.
Более того, если дословно следовать описанной методологии, то мы столкнемся с тем, что вернувшихся клиентов (которые сделали более одного заказа за указанный период) больше чем новых клиентов (которые сделали только один заказ за указанный период). Это противоречит бизнес-логике.
Также, например, непонятно, что должно быть в поле item_id? Можно конечно собрать все item_id в массив и сделать недельные агрегаты, но я не уверен, что это добавит витрине информативности. Исходя из этого я изменил методологию расчета необходимых метрик и собрал витрину исходя из собственного опыта. Посмотрите, если будет нужно, я внесу необходимые изменения.
