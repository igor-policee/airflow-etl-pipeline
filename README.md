# ETL-пайплайн

Пайплайн включает в себя следующие этапы:

1. Проверка наличия поля `status` в таблицах `staging.user_order_log` и `mart.f_sales`. Если поле в таблицах отсутствует, то оно создается. 
2. Генерация ключей для загрузки данных из хранилища (s3) за логическую дату выполнения задачи. Загружаемые ключи: "task_id", "report_id", "increment_id".
3. Удаление из таблиц `mart.f_sales` и `staging.user_order_log` данных за логическую дату задачи для обеспечения идемпотентности.
4. Выгрузка инкрементальных данных в staging (таблица `staging.user_order_log`) за логическую дату задачи. Данные загружаются в исходном виде. Если поле `status` в исходном файле отсутствует, то соответствующие значения в таблице `staging.user_order_log` устанавливаются как NULL.
5. Копирование данных из `staging.user_order_log` в `mart.f_sales` за логическую дату задачи с применением дополнительных условий в соответствии с бизнес-логикой:
   + значения NULL в поле `status` заменяются на 'shipped';
   + если в поле `status` указано значение 'refunded' и значение в поле `payment_amount` > 0, то значение в поле `payment_amount` меняется на отрицательное.
6. Создание представления `mart.f_customer_retention` для расчета метрик customer retention с разбивкой по неделям. Представление содержит следующие поля:
   + `period_id` — идентификатор периода (номер недели или номер месяца);
   + `period_name` — weekly;
   + `new_customers_count` — кол-во новых клиентов;
   + `returning_customers_count` — кол-во вернувшихся клиентов;
   + `refunded_customer_count` — кол-во клиентов, оформивших возврат за рассматриваемый промежуток времени;
   + `item_id` — идентификатор категории товара;
   + `new_customers_revenue` — доход с новых клиентов;
   + `returning_customers_revenue` — доход с вернувшихся клиентов;
   + `customers_refunded` — количество возвратов клиентов.
