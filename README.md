# ETL-пайплайн

### Пайплайн выполняется ежедневно (00:00 UTC) и включает в себя следующие этапы:

1. Проверка наличия поля `status` в таблицах `staging.user_order_log` и `mart.f_sales`. Если поле `status` в таблицах отсутствует, то оно создается. 
2. Генерация и загрузка ключей для загрузки данных из хранилища (s3) за логическую дату выполнения задачи. Загружаемые ключи: "task_id", "report_id", "increment_id".
3. Удаление данных из таблиц `mart.f_sales` и `staging.user_order_log` за логическую дату задачи для обеспечения идемпотентности.
4. Выгрузка инкрементальных данных в staging (таблица `staging.user_order_log`) за логическую дату задачи. Данные загружаются в исходном виде. Если поле `status` в исходном файле отсутствует, то соответствующие значения в таблице `staging.user_order_log` устанавливаются как NULL.
5. Копирование данных из `staging.user_order_log` в `mart.f_sales` за логическую дату задачи с применением дополнительных условий в соответствии с бизнес-логикой:
   + значения NULL в поле `status` заменяются на 'shipped';
   + положительные значения в поле `payment_amount` заменяются на отрицательные, если указан `status` 'refunded'.
6. Создание представления `mart.f_customer_retention` для расчета метрик customer retention с разбивкой по неделям. Представление содержит следующие поля:
   + `week_of_year` — номер недели;
   + `new_customers_count` — кол-во новых клиентов;
   + `returning_customers_count` — кол-во вернувшихся клиентов;
   + `refunded_customer_count` — кол-во уникальных клиентов, оформивших возврат за рассматриваемый промежуток времени;
   + `purchase_refunds_count` — кол-во возвратов за рассматриваемый промежуток времени;
   + `new_customers_revenue` — доход с новых клиентов;
   + `returning_customers_revenue` — доход с вернувшихся клиентов.

### Скрипты:

+ [DAG (пайплайн)](src/DAG/upload_increment_data.py)

+ [SQL-запросы](migrations)
